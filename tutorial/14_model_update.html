

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>15. Model Update &mdash; LASIF 0.1.x documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="LASIF 0.1.x documentation" href="../index.html"/>
        <link rel="up" title="Tutorial" href="../tutorial.html"/>
        <link rel="next" title="16. Next Iterations" href="15_next_iterations.html"/>
        <link rel="prev" title="14. Misfit and Adjoint Source Calculation" href="13_misfits_and_adjoint_sources.html"/> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> LASIF
          

          
          </a>

          
            
            
              <div class="version">
                0.1.x
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../prerequisites.html">Installation, Testing &amp; DevInfo</a></li>
<li class="toctree-l1"><a class="reference internal" href="../introduction.html">Introduction</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../tutorial.html">Tutorial</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="00_interfaces.html">1. Interfaces</a></li>
<li class="toctree-l2"><a class="reference internal" href="01_creating_a_new_project.html">2. Creating a New Project</a></li>
<li class="toctree-l2"><a class="reference internal" href="02_seismic_events.html">3. Seismic Events</a></li>
<li class="toctree-l2"><a class="reference internal" href="03_station_data.html">4. Station Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="04_waveform_data.html">5. Waveform Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="05_download_helpers.html">6. Download Helpers</a></li>
<li class="toctree-l2"><a class="reference internal" href="06_data_inspection.html">7. Data Inspection</a></li>
<li class="toctree-l2"><a class="reference internal" href="07_data_validation.html">8. Data Validation</a></li>
<li class="toctree-l2"><a class="reference internal" href="08_a_new_iteration.html">9. Defining a New Iteration</a></li>
<li class="toctree-l2"><a class="reference internal" href="09_data_preprocessing.html">10. Data Preprocessing</a></li>
<li class="toctree-l2"><a class="reference internal" href="10_model_handling.html">11. Earth Model Handling</a></li>
<li class="toctree-l2"><a class="reference internal" href="11_generating_input_files.html">12. Generating Input Files</a></li>
<li class="toctree-l2"><a class="reference internal" href="12_synthetic_waveforms.html">13. Synthetics</a></li>
<li class="toctree-l2"><a class="reference internal" href="13_misfits_and_adjoint_sources.html">14. Misfit and Adjoint Source Calculation</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">15. Model Update</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#actual-model-update">15.1. Actual model update</a></li>
<li class="toctree-l3"><a class="reference internal" href="#line-search-model-update-check">15.2. Line Search/Model Update Check</a></li>
<li class="toctree-l3"><a class="reference internal" href="#simple-update-script">15.3. Simple Update Script</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="15_next_iterations.html">16. Next Iterations</a></li>
<li class="toctree-l2"><a class="reference internal" href="16_customizing_lasif.html">17. Customizing LASIF</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../cli.html">Command Line Interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../webinterface.html">Web Interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api_doc.html">API Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../faq.html">FAQ</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../index.html">LASIF</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          

 



<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html">Docs</a> &raquo;</li>
      
          <li><a href="../tutorial.html">Tutorial</a> &raquo;</li>
      
    <li>15. Model Update</li>
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../_sources/tutorial/14_model_update.txt" rel="nofollow"> View page source</a>
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <p class="centered">
<strong>Last updated on <em>August 12th 2016</em>.</strong></p><div class="admonition note">
<p class="first admonition-title">Note</p>
<p>The following links shows the example project as it should be just before
step 14. You can use this to check your progress or restart the tutorial at
this very point.</p>
<p class="last"><a class="reference external" href="https://github.com/krischer/LASIF_Tutorial/tree/after_step_14_misfit_and_adjoint_source">After Step 14: Misfit and Adjoint Sources</a></p>
</div>
<div class="section" id="model-update">
<h1>15. Model Update<a class="headerlink" href="#model-update" title="Permalink to this headline">¶</a></h1>
<p><strong>LASIF</strong> per se does not aid you with actually updating the model. This is a
concious design decision as a large part of the research or black art aspect in
full seismic waveform inversions actually comes from the model update,
potential preconditioning, and the actually employed numerical optimization
scheme.</p>
<p>This parts illustrates a simple update. When running a real inversion, please
consider spending a couple of days to scripts model updates and everything else
required around a given LASIF project.</p>
<div class="section" id="actual-model-update">
<h2>15.1. Actual model update<a class="headerlink" href="#actual-model-update" title="Permalink to this headline">¶</a></h2>
<p>Because LASIF does not (yet) aid you with updating the model, you will have
to do this manually. Keep in mind that the kernels SES3D produces initially
are the raw gradients, and unsmoothed. You will probably need to smooth them
before updating the model to get reasonable results without excessive
focusing near sources and/or receivers.</p>
</div>
<div class="section" id="line-search-model-update-check">
<h2>15.2. Line Search/Model Update Check<a class="headerlink" href="#line-search-model-update-check" title="Permalink to this headline">¶</a></h2>
<p>At one point you will have to check the total misfit for a certain iteration
and model - be it for a line search or to check a new test model. The
recommended strategy to do this within LASIF is to use &#8220;side-iterations&#8221;, e.g.
in the following we will test the misfit for a model update with a step length
of 0.5:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ lasif create_successive_iteration <span class="m">1</span> 1_steplength_0.5
$ lasif migrate_windows <span class="m">1</span> 1_steplength_0.5
<span class="c1"># Copy synthetics for the test iteration - then calculate both misfits.</span>
$ mpirun -n <span class="m">4</span> lasif compare_misfits <span class="m">1</span> 1_steplength_0.5
</pre></div>
</div>
<p>You will notice that the <code class="docutils literal"><span class="pre">compare_misfits</span></code> command always requires two
iterations. This is necessary as any  misfit must be calculated for exactly the
same stations, windows, and weights for two iterations to be comparable.  For
steepest/gradient descent optimization methods it is fine to just take the
current and next iteration, for others like conjugate gradient and L-BFGS make
sure to choose the correct baseline iteration to get comparable misfit
measurements!</p>
</div>
<div class="section" id="simple-update-script">
<h2>15.3. Simple Update Script<a class="headerlink" href="#simple-update-script" title="Permalink to this headline">¶</a></h2>
<p>The following is a short script that demonstrates the principles of how to
perform a model update. It does a simple gradient descent update at various
step lengths that then have to be tested. It requires the initial model as well
as the kernels to be in the SES3D regular grid format and utilizes the Python
tools shipping with SES3D.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1"># -*- coding: utf-8 -*-</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="c1"># This is from the SES3D Python tools.</span>
<span class="kn">import</span> <span class="nn">models</span> <span class="kn">as</span> <span class="nn">m</span>

<span class="c1"># Input. ----------------------------------------------------------------------</span>
<span class="c1"># Directory where the current model is located.</span>
<span class="n">dir_current_model</span> <span class="o">=</span> <span class="s2">&quot;../MODELS/MODELS_3D/MODEL.66/&quot;</span>

<span class="c1"># Directory where test models will be written.</span>
<span class="n">dir_test_models</span> <span class="o">=</span> <span class="s2">&quot;../MODELS/MODELS_3D/MODEL.67/&quot;</span>

<span class="c1"># Directory where current gradients are located.</span>
<span class="n">dir_kernels</span> <span class="o">=</span> <span class="s2">&quot;../GRADIENTS/ITERATION_1/&quot;</span>

<span class="c1"># List of events for which kernels are available.</span>
<span class="n">eventlist</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;GCMT_event_NORTHERN_ITALY_Mag_4.9_2000-8-21-17&quot;</span><span class="p">,</span>
    <span class="s2">&quot;GCMT_event_NORTHWESTERN_BALKAN_REGION_Mag_5.9_1980-5-18-20&quot;</span><span class="p">]</span>

<span class="c1"># Smoothing iterations.</span>
<span class="n">sigma</span> <span class="o">=</span> <span class="mf">3.0</span>

<span class="c1"># Test step lengths.</span>
<span class="n">gamma</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.15</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]</span>

<span class="c1"># Read current model. ---------------------------------------------------------</span>
<span class="k">print</span> <span class="s2">&quot;read current model from directory &quot;</span> <span class="o">+</span> <span class="n">dir_current_model</span>

<span class="n">csv</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">ses3d_model</span><span class="p">()</span>
<span class="n">csh</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">ses3d_model</span><span class="p">()</span>
<span class="n">rho</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">ses3d_model</span><span class="p">()</span>
<span class="n">cp</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">ses3d_model</span><span class="p">()</span>

<span class="n">csv</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">dir_current_model</span><span class="p">,</span> <span class="s1">&#39;dvsv&#39;</span><span class="p">)</span>
<span class="n">csh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">dir_current_model</span><span class="p">,</span> <span class="s1">&#39;dvsh&#39;</span><span class="p">)</span>
<span class="n">rho</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">dir_current_model</span><span class="p">,</span> <span class="s1">&#39;drho&#39;</span><span class="p">)</span>
<span class="n">cp</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">dir_current_model</span><span class="p">,</span> <span class="s1">&#39;dvp&#39;</span><span class="p">)</span>

<span class="c1"># Read gradients of the current iteration. ------------------------------------</span>
<span class="c1"># Initialisation.</span>
<span class="n">grad_csv</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">ses3d_model</span><span class="p">()</span>
<span class="n">grad_csh</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">ses3d_model</span><span class="p">()</span>
<span class="n">grad_rho</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">ses3d_model</span><span class="p">()</span>
<span class="n">grad_cp</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">ses3d_model</span><span class="p">()</span>

<span class="n">grad_csv_k</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">ses3d_model</span><span class="p">()</span>
<span class="n">grad_csh_k</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">ses3d_model</span><span class="p">()</span>
<span class="n">grad_rho_k</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">ses3d_model</span><span class="p">()</span>
<span class="n">grad_cp_k</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">ses3d_model</span><span class="p">()</span>

<span class="c1"># Loop through events.</span>
<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">eventlist</span><span class="p">:</span>

    <span class="k">print</span> <span class="s2">&quot;read kernels for event &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="n">eventlist</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>

        <span class="c1">#  Read kernels.</span>
        <span class="n">grad_csv</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">dir_kernels</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;gradient_csv&#39;</span><span class="p">)</span>
        <span class="n">grad_csh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">dir_kernels</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;gradient_csh&#39;</span><span class="p">)</span>
        <span class="n">grad_rho</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">dir_kernels</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;gradient_rho&#39;</span><span class="p">)</span>
        <span class="n">grad_cp</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">dir_kernels</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;gradient_cp&#39;</span><span class="p">)</span>

        <span class="c1">#  Clip the upper percentile to remove singularities.</span>
        <span class="n">grad_csv</span><span class="o">.</span><span class="n">clip_percentile</span><span class="p">(</span><span class="mf">99.9</span><span class="p">)</span>
        <span class="n">grad_csh</span><span class="o">.</span><span class="n">clip_percentile</span><span class="p">(</span><span class="mf">99.9</span><span class="p">)</span>
        <span class="n">grad_cp</span><span class="o">.</span><span class="n">clip_percentile</span><span class="p">(</span><span class="mf">99.9</span><span class="p">)</span>
        <span class="n">grad_rho</span><span class="o">.</span><span class="n">clip_percentile</span><span class="p">(</span><span class="mf">99.9</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>

        <span class="c1"># Read kernels.</span>
        <span class="n">grad_csv_k</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">dir_kernels</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;gradient_csv&#39;</span><span class="p">)</span>
        <span class="n">grad_csh_k</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">dir_kernels</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;gradient_csh&#39;</span><span class="p">)</span>
        <span class="n">grad_rho_k</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">dir_kernels</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;gradient_rho&#39;</span><span class="p">)</span>
        <span class="n">grad_cp_k</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">dir_kernels</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;gradient_cp&#39;</span><span class="p">)</span>

        <span class="c1"># Clip the upper percentile to remove singularities.</span>
        <span class="n">grad_csv_k</span><span class="o">.</span><span class="n">clip_percentile</span><span class="p">(</span><span class="mf">99.9</span><span class="p">)</span>
        <span class="n">grad_csh_k</span><span class="o">.</span><span class="n">clip_percentile</span><span class="p">(</span><span class="mf">99.9</span><span class="p">)</span>
        <span class="n">grad_cp_k</span><span class="o">.</span><span class="n">clip_percentile</span><span class="p">(</span><span class="mf">99.9</span><span class="p">)</span>
        <span class="n">grad_rho_k</span><span class="o">.</span><span class="n">clip_percentile</span><span class="p">(</span><span class="mf">99.9</span><span class="p">)</span>

        <span class="c1"># Add to the previous kernels.</span>
        <span class="n">grad_csv</span> <span class="o">=</span> <span class="n">grad_csv</span> <span class="o">+</span> <span class="n">grad_csv_k</span>
        <span class="n">grad_csh</span> <span class="o">=</span> <span class="n">grad_csh</span> <span class="o">+</span> <span class="n">grad_csh_k</span>
        <span class="n">grad_rho</span> <span class="o">=</span> <span class="n">grad_rho</span> <span class="o">+</span> <span class="n">grad_rho_k</span>
        <span class="n">grad_cp</span> <span class="o">=</span> <span class="n">grad_cp</span> <span class="o">+</span> <span class="n">grad_cp_k</span>

<span class="c1"># Compute the new descent direction. ------------------------------------------</span>
<span class="c1"># Simple gradient descent.</span>
<span class="n">h_csv</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span> <span class="o">*</span> <span class="n">grad_csv</span>
<span class="n">h_csh</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span> <span class="o">*</span> <span class="n">grad_csh</span>
<span class="n">h_cp</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span> <span class="o">*</span> <span class="n">grad_cp</span>
<span class="n">h_rho</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span> <span class="o">*</span> <span class="n">grad_rho</span>

<span class="c1"># Store new gradients and descent directions. ---------------------------------</span>
<span class="n">grad_csv</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">dir_kernels</span><span class="p">,</span> <span class="s1">&#39;gradient_csv_sum&#39;</span><span class="p">)</span>
<span class="n">grad_csh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">dir_kernels</span><span class="p">,</span> <span class="s1">&#39;gradient_csh_sum&#39;</span><span class="p">)</span>
<span class="n">grad_rho</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">dir_kernels</span><span class="p">,</span> <span class="s1">&#39;gradient_rho_sum&#39;</span><span class="p">)</span>
<span class="n">grad_cp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">dir_kernels</span><span class="p">,</span> <span class="s1">&#39;gradient_cp_sum&#39;</span><span class="p">)</span>

<span class="n">h_csv</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">dir_kernels</span><span class="p">,</span> <span class="s1">&#39;h_csv_sum&#39;</span><span class="p">)</span>
<span class="n">h_csh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">dir_kernels</span><span class="p">,</span> <span class="s1">&#39;h_csh_sum&#39;</span><span class="p">)</span>
<span class="n">h_rho</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">dir_kernels</span><span class="p">,</span> <span class="s1">&#39;h_rho_sum&#39;</span><span class="p">)</span>
<span class="n">h_cp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">dir_kernels</span><span class="p">,</span> <span class="s1">&#39;h_cp_sum&#39;</span><span class="p">)</span>

<span class="c1"># Apply smoothing. ------------------------------------------------------------</span>
<span class="k">print</span> <span class="s2">&quot;smoothing&quot;</span>

<span class="n">h_csv</span><span class="o">.</span><span class="n">smooth_horizontal</span><span class="p">(</span><span class="n">sigma</span><span class="p">,</span> <span class="n">filter_type</span><span class="o">=</span><span class="s1">&#39;neighbour&#39;</span><span class="p">)</span>
<span class="n">h_csh</span><span class="o">.</span><span class="n">smooth_horizontal</span><span class="p">(</span><span class="n">sigma</span><span class="p">,</span> <span class="n">filter_type</span><span class="o">=</span><span class="s1">&#39;neighbour&#39;</span><span class="p">)</span>
<span class="n">h_cp</span><span class="o">.</span><span class="n">smooth_horizontal</span><span class="p">(</span><span class="n">sigma</span><span class="p">,</span> <span class="n">filter_type</span><span class="o">=</span><span class="s1">&#39;neighbour&#39;</span><span class="p">)</span>
<span class="n">h_rho</span><span class="o">.</span><span class="n">smooth_horizontal</span><span class="p">(</span><span class="n">sigma</span><span class="p">,</span> <span class="n">filter_type</span><span class="o">=</span><span class="s1">&#39;neighbour&#39;</span><span class="p">)</span>

<span class="c1"># Relative importance of the kernels. -----------------------------------------</span>
<span class="n">sum_csv</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="n">sum_csh</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="n">sum_rho</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="n">sum_cp</span> <span class="o">=</span> <span class="mf">0.0</span>

<span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">grad_csv</span><span class="o">.</span><span class="n">nsubvol</span><span class="p">):</span>

    <span class="n">sum_csv</span> <span class="o">=</span> <span class="n">sum_csv</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">h_csv</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">v</span><span class="p">))</span>
    <span class="n">sum_csh</span> <span class="o">=</span> <span class="n">sum_csh</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">h_csh</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">v</span><span class="p">))</span>
    <span class="n">sum_rho</span> <span class="o">=</span> <span class="n">sum_rho</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">h_rho</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">v</span><span class="p">))</span>
    <span class="n">sum_cp</span> <span class="o">=</span> <span class="n">sum_cp</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">h_cp</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">v</span><span class="p">))</span>

<span class="n">max_sum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="n">sum_csv</span><span class="p">,</span> <span class="n">sum_csh</span><span class="p">,</span> <span class="n">sum_cp</span><span class="p">,</span> <span class="n">sum_rho</span><span class="p">])</span>

<span class="n">scale_csv_total</span> <span class="o">=</span> <span class="n">sum_csv</span> <span class="o">/</span> <span class="n">max_sum</span>
<span class="n">scale_csh_total</span> <span class="o">=</span> <span class="n">sum_csh</span> <span class="o">/</span> <span class="n">max_sum</span>
<span class="n">scale_rho_total</span> <span class="o">=</span> <span class="n">sum_rho</span> <span class="o">/</span> <span class="n">max_sum</span>
<span class="n">scale_cp_total</span> <span class="o">=</span> <span class="n">sum_cp</span> <span class="o">/</span> <span class="n">max_sum</span>

<span class="k">print</span> <span class="n">scale_csv_total</span><span class="p">,</span> <span class="n">scale_csh_total</span><span class="p">,</span> <span class="n">scale_rho_total</span><span class="p">,</span> <span class="n">scale_cp_total</span>

<span class="c1"># Depth scaling.---------------------------------------------------------------</span>
<span class="n">max_csv</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">max_csh</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">max_rho</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">max_cp</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">h_csv</span><span class="o">.</span><span class="n">nsubvol</span><span class="p">):</span>

    <span class="n">max_csv</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">h_csv</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">v</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:])))</span>
    <span class="n">max_csh</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">h_csh</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">v</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:])))</span>
    <span class="n">max_rho</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">h_rho</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">v</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:])))</span>
    <span class="n">max_cp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">h_cp</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">v</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:])))</span>

<span class="n">max_csv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">max_csv</span><span class="p">)</span>
<span class="n">max_csh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">max_csh</span><span class="p">)</span>
<span class="n">max_rho</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">max_rho</span><span class="p">)</span>
<span class="n">max_cp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">max_cp</span><span class="p">)</span>

<span class="n">damp</span> <span class="o">=</span> <span class="mf">0.3</span>

<span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">h_csv</span><span class="o">.</span><span class="n">nsubvol</span><span class="p">):</span>

    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">h_csv</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">r</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>

        <span class="n">h_csv</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">v</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">h_csv</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">v</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">k</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span>
            <span class="n">damp</span> <span class="o">*</span> <span class="n">max_csv</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">h_csv</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">v</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">k</span><span class="p">])))</span>
        <span class="n">h_csh</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">v</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">h_csh</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">v</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">k</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span>
            <span class="n">damp</span> <span class="o">*</span> <span class="n">max_csh</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">h_csh</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">v</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">k</span><span class="p">])))</span>
        <span class="n">h_rho</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">v</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">h_rho</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">v</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">k</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span>
            <span class="n">damp</span> <span class="o">*</span> <span class="n">max_rho</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">h_rho</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">v</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">k</span><span class="p">])))</span>
        <span class="n">h_cp</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">v</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">h_cp</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">v</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">k</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span>
            <span class="n">damp</span> <span class="o">*</span> <span class="n">max_cp</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">h_cp</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">v</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">k</span><span class="p">])))</span>

<span class="n">h_csv</span> <span class="o">=</span> <span class="n">scale_csv_total</span> <span class="o">*</span> <span class="n">h_csv</span>
<span class="n">h_csh</span> <span class="o">=</span> <span class="n">scale_csh_total</span> <span class="o">*</span> <span class="n">h_csh</span>
<span class="n">h_rho</span> <span class="o">=</span> <span class="n">scale_rho_total</span> <span class="o">*</span> <span class="n">h_rho</span>
<span class="n">h_cp</span> <span class="o">=</span> <span class="n">scale_cp_total</span> <span class="o">*</span> <span class="n">h_cp</span>

<span class="c1"># Store the smoothed descent directions. --------------------------------------</span>
<span class="n">h_csv</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">dir_kernels</span><span class="p">,</span> <span class="s1">&#39;h_csv_sum_smoothed&#39;</span><span class="p">)</span>
<span class="n">h_csh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">dir_kernels</span><span class="p">,</span> <span class="s1">&#39;h_csh_sum_smoothed&#39;</span><span class="p">)</span>
<span class="n">h_rho</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">dir_kernels</span><span class="p">,</span> <span class="s1">&#39;h_rho_sum_smoothed&#39;</span><span class="p">)</span>
<span class="n">h_cp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">dir_kernels</span><span class="p">,</span> <span class="s1">&#39;h_cp_sum_smoothed&#39;</span><span class="p">)</span>

<span class="c1"># Compute and store updates. --------------------------------------------------</span>
<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">gamma</span><span class="p">)):</span>
    <span class="n">csv_new</span> <span class="o">=</span> <span class="n">csv</span> <span class="o">+</span> <span class="n">gamma</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="n">h_csv</span>
    <span class="n">csh_new</span> <span class="o">=</span> <span class="n">csh</span> <span class="o">+</span> <span class="n">gamma</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="n">h_csh</span>
    <span class="n">rho_new</span> <span class="o">=</span> <span class="n">rho</span> <span class="o">+</span> <span class="n">gamma</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="n">h_rho</span>
    <span class="n">cp_new</span> <span class="o">=</span> <span class="n">cp</span> <span class="o">+</span> <span class="n">gamma</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="n">h_cp</span>

    <span class="n">csv_new</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">dir_test_models</span><span class="p">,</span> <span class="s1">&#39;dvsv.&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">gamma</span><span class="p">[</span><span class="n">k</span><span class="p">]))</span>
    <span class="n">csh_new</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">dir_test_models</span><span class="p">,</span> <span class="s1">&#39;dvsh.&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">gamma</span><span class="p">[</span><span class="n">k</span><span class="p">]))</span>
    <span class="n">rho_new</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">dir_test_models</span><span class="p">,</span> <span class="s1">&#39;drho.&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">gamma</span><span class="p">[</span><span class="n">k</span><span class="p">]))</span>
    <span class="n">cp_new</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">dir_test_models</span><span class="p">,</span> <span class="s1">&#39;dvp.&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">gamma</span><span class="p">[</span><span class="n">k</span><span class="p">]))</span>
</pre></div>
</div>
</div>
</div>


           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="15_next_iterations.html" class="btn btn-neutral float-right" title="16. Next Iterations" accesskey="n">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="13_misfits_and_adjoint_sources.html" class="btn btn-neutral" title="14. Misfit and Adjoint Source Calculation" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2016, Lion Krischer &amp; Andreas Fichtner.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'0.1.x',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>